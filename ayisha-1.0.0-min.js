/*!
 * Ayisha.js v1.0.0
 * (c) 2025 devBen - Benito Massidda
 * License: MIT
 */
!function(){if(window.AyishaVDOM)return;class t{constructor(t){this.state=t}evalExpr(t,e={},s){const i=t.trim();if(/^['"].*['"]$/.test(i))return i.slice(1,-1);if(/^\d+(\.\d+)?$/.test(i))return Number(i);try{const i=new Proxy(this.state,{get:(t,e)=>t[e],set:(t,e,s)=>(t[e]=s,!0)});return new Function("state","ctx","event",`with(state){with(ctx||{}){return (${t})}}`)(i,e,s)}catch{return}}executeMultipleExpressions(t,e={},s){const i=t.trim();if(!this.hasMultipleAssignments(i))return!1;const r=this.parseMultipleExpressions(i);try{const t=new Proxy(this.state,{get:(t,e)=>t[e],set:(t,e,s)=>(t[e]=s,!0)});for(const i of r)i.trim()&&new Function("state","ctx","event",`with(state){with(ctx||{}){${i.trim()}}}`)(t,e,s);return!0}catch(t){return!1}}executeDirectiveExpression(t,e={},s=null,i=!0){let r=t;this.hasInterpolation(t)&&(r=this.evalAttrValue(t,e));const n=r.replace(/\bstate\./g,"");try{if(this.executeMultipleExpressions(n,e,s))return i&&setTimeout((()=>window.ayisha&&window.ayisha.render()),0),!0;return new Function("state","ctx","event",`with(state){with(ctx||{}){${n}}}`)(this.state,e||{},s),i&&setTimeout((()=>window.ayisha&&window.ayisha.render()),0),!0}catch(t){return!1}}hasMultipleAssignments(t){if(t.includes("=>"))return!1;if(t.includes("(")&&t.includes(")")){return t.includes(";")}if(t.includes(";"))return!0;if(t.includes(",")&&!t.includes("("))return!0;return/\w+\s*=\s*[^=\s]+\s+\w+\s*=\s*/.test(t)}parseMultipleExpressions(t){if(t.includes(";"))return t.split(";").map((t=>t.trim())).filter((t=>t));if(t.includes(",")&&!t.includes("("))return t.split(",").map((t=>t.trim())).filter((t=>t));const e=[];let s="",i=!1,r="",n=0,a=0;for(;a<t.length;){const o=t[a];if(i||'"'!==o&&"'"!==o)if(i&&o===r&&"\\"!==t[a-1])i=!1,r="",s+=o;else if(i||"("!==o)if(i||")"!==o)if(i||" "!==o||0!==n)s+=o;else{t.substring(a+1).trim().match(/^\w+\s*=/)&&s.trim().includes("=")?(e.push(s.trim()),s=""):s+=o}else n--,s+=o;else n++,s+=o;else i=!0,r=o,s+=o;a++}return s.trim()&&e.push(s.trim()),e.length>1?e:[t]}evalText(t,e){return t.replace(/{{(.*?)}}/g,((t,s)=>{const i=this.evalExpr(s.trim(),e);return null!=i?i:""}))}evalAttrValue(t,e){let s=t.replace(/{{(.*?)}}/g,((t,s)=>{const i=this.evalExpr(s.trim(),e);return null!=i?i:""}));if(s=s.replace(/\[\{(.*?)\}\]/g,((t,s)=>{const i=this.evalExpr(s.trim(),e);return null!=i?i:""})),/^\{([^{}]+)\}$/.test(s.trim())){const t=s.trim().slice(1,-1),i=this.evalExpr(t,e);return null!=i?i:""}return s=s.replace(/\{([^{}]+)\}/g,((t,s)=>{if(/^\{\{.*\}\}$/.test(t))return t;const i=this.evalExpr(s.trim(),e);return null!=i?i:""})),s}autoVarExpr(t){return"string"==typeof t&&/^\w+$/.test(t.trim())?`{${t.trim()}}`:t}hasInterpolation(t){return/\{\{.*?\}\}|\{[\w$.]+\}/.test(t)}ensureVarInState(t,e=!1,s=null){if("string"!=typeof t)return;const i=["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"],r=t.match(/([\w$]+)\.(push|pop|shift|unshift|filter|map|reduce|forEach|length|slice|splice)/);if(r){const t=r[1];return void(i.includes(t)||t in this.state||(this.state[t]=[]))}const n=t.split(".")[0];i.includes(n)||n in this.state||("number"===s?this.state[n]=0:"checkbox"===s?this.state[n]=!1:e?this.state[n]=void 0:/items|list|array|data|results|errors|posts|todos|users/.test(n)?this.state[n]=[]:/count|total|index|id|size|length|number|num/.test(n)?this.state[n]=0:/show|hide|is|has|can|should|valid|enable|subscribed/.test(n)?this.state[n]=!1:/user|config|form|settings/.test(n)?this.state[n]={}:this.state[n]=void 0);const a=t.match(/([\w$][\w\d$]*(?:\.[\w$][\w\d$]*)+)/);if(a){const t=a[1].split("."),e=t[0];if(i.includes(e))return;let s=this.state;for(let e=0;e<t.length;e++){const i=t[e];i in s?e<t.length-1&&"object"!=typeof s[i]&&(s[i]={}):s[i]=e===t.length-1?void 0:{},s=s[i]}}}safeSetArrayVariable(t,e){try{this.state[t]=e}catch(s){Object.defineProperty(this.state,t,{value:e,writable:!0,configurable:!0,enumerable:!0})}}}class e{constructor(t){this.initBlocks=t}parse(t){if(!t)return null;if(11===t.nodeType){const e={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};return t.childNodes.forEach((t=>{const s=this.parse(t);s&&e.children.push(s)})),e}if(3===t.nodeType)return{type:"text",text:t.textContent};if(1!==t.nodeType)return null;const e=t.tagName.toLowerCase();if("init"===e)return this.initBlocks.push(t.textContent),null;if("no"===e)return{tag:"no",attrs:{},directives:{},subDirectives:{},children:[],rawContent:t.innerHTML};const s={tag:e,attrs:{},directives:{},subDirectives:{},children:[]};for(const e of Array.from(t.attributes))if(e.name.startsWith("@")){const t=e.name.split(":");if(2===t.length){const[i,r]=t;s.subDirectives[i]=s.subDirectives[i]||{},s.subDirectives[i][r]=e.value}else s.directives[e.name]=e.value}else s.attrs[e.name]=e.value;return t.childNodes&&t.childNodes.length>0&&t.childNodes.forEach((t=>{const e=this.parse(t);e&&s.children.push(e)})),s}}class s{constructor(){this.components={},this.cache={},this.loadingComponents=new Map,this.debugMode=!0}component(t,e){this.components[t]=e}async loadExternalComponent(t){if(this.debugMode,this.cache[t])return this.debugMode,this.cache[t];if(this.loadingComponents.has(t))return this.debugMode,this.loadingComponents.get(t);const e=this._fetchComponent(t);this.loadingComponents.set(t,e);try{const s=await e;return this.cache[t]=s,this.debugMode,s}catch(t){return null}finally{this.loadingComponents.delete(t)}}async _fetchComponent(t){this.debugMode;const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const s=await e.text();return this.debugMode,s}getComponent(t){return this.components[t]}getCachedComponent(t){return this.cache[t]}isLoading(t){return this.loadingComponents.has(t)}setDebugMode(t){this.debugMode=t}}class i{constructor(t,e){this.state=t,this.watchers={},this.renderCallback=e,this.watchersReady=!1,this._isUpdating=!1,this._renderTimeout=null}makeReactive(){return this.state=new Proxy(this.state,{set:(t,e,s)=>{if(this._isUpdating)return t[e]=s,!0;const i=t[e];return JSON.stringify(i)===JSON.stringify(s)?(t[e]=s,!0):(this._isUpdating=!0,t[e]=s,this.watchersReady&&this.watchers[e]&&this.watchers[e].forEach((t=>{try{t(s)}catch(t){}})),this._renderTimeout&&clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout((()=>{this._isUpdating=!1,this._renderTimeout=null,this.renderCallback()}),10),!0)}}),this.state}addWatcher(t,e){this.watchers[t]=this.watchers[t]||[],this.watchers[t].push(e)}enableWatchers(){this.watchersReady=!0}}class r{constructor(t,e){this.state=t,this.renderCallback=e}setupRouting(){let t=location.pathname.replace(/^\//,"")||"";t&&"index.html"!==t||(history.replaceState({},"","/"),t=""),this.state._currentPage||(this.state._currentPage=t),window.addEventListener("popstate",(()=>{this.state._currentPage=location.pathname.replace(/^\//,"")||"",this.renderCallback()}))}setupCurrentPageProperty(){const t=this;let e=this.state._currentPage;Object.defineProperty(this.state,"_currentPage",{get:()=>e,set(s){e!==s&&(e=s,history.pushState({},"","/"+s),t.renderCallback())}})}}class n{constructor(t){this.evaluator=t,this.pendingFetches={},this.lastFetchUrl={},this.fetched={}}setupFetch(t,e,s,i,r){let n=this.evaluator.evalExpr(t,s,i);if(void 0===n&&(n=t.replace(/\{([^}]+)\}/g,((t,e)=>{const r=this.evaluator.evalExpr(e,s,i);return null!=r?r:""}))),null==n&&(n=t),!n)return;const a=`${n}::${e}`;(r||this.lastFetchUrl[e]!==n)&&(this.pendingFetches[a]||(this.pendingFetches[a]=!0,this.lastFetchUrl[e]=n,e in this.evaluator.state||(this.evaluator.state[e]=null),fetch(n).then((t=>{if(!t.ok)throw this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=`${t.status} ${t.statusText||"errore di rete"}`,new Error(`${t.status} ${t.statusText}`);return t.json()})).then((t=>{const s=this.evaluator.state[e];JSON.stringify(s)===JSON.stringify(t)||(this.evaluator.state[e]=t),this.fetched[n]&&delete this.fetched[n].error})).catch((t=>{this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error||(this.fetched[n].error=t.message)})).finally((()=>{delete this.pendingFetches[a]}))))}}class a{constructor(){this.helpTexts={"@if":'Esempio: <div @if="condizione">Mostra se condizione è true</div>',"@show":'Esempio: <div @show="condizione">Mostra se condizione è true</div>',"@hide":'Esempio: <div @hide="condizione">Nasconde se condizione è true</div>',"@for":'Esempio: <li @for="item in items">{{item}}</li> o <li @for="i, item in items">{{i}}: {{item}}</li>',"@model":'Esempio: <input @model="nome">',"@click":'Esempio: <button @click="state.count++">Aumenta</button>',"@fetch":'Esempio: <div @fetch="\'url\'" @result="data">Carica</div>',"@result":'Esempio: <div @fetch="\'url\'" @result="data">Carica</div>',"@watch":'Esempio: <div @watch="prop=>console.log(prop)"></div>',"@text":'Esempio: <span @text="nome"></span>',"@class":'Esempio: <div @class="{rosso: condizione}"></div>',"@style":"Esempio: <div @style=\"{color:'red'}\"></div>","@validate":'Esempio: <input @validate="required,minLength:3">',"@link":'Esempio: <a @link="pagina">Vai</a>',"@page":'Esempio: <div @page="home">Solo su home</div>',"@component":'Esempio: <component @src="comp.html"></component>',"@set":'Esempio: <button @set:click="foo=1"></button>',"@key":'Esempio: <li @for="item in items" @key="item.id"></li>',"@src":'Esempio: <component @src="comp.html"></component>',"@switch":'Esempio: <div @switch="valore"><div @case="1">Uno</div><div @default>Altro</div></div>',"@case":'Esempio: <div @case="1">Uno</div>',"@default":"Esempio: <div @default>Altro</div>","@source":'Esempio: <div @source="items" @map="item => item*2" @result="doppio"></div>',"@map":'Esempio: <div @source="items" @map="item => item*2"></div>',"@filter":'Esempio: <div @source="items" @filter="item > 0"></div>',"@reduce":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@initial":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@animate":'Esempio: <div @animate="fade-in"></div>',"@state":"Esempio: <div @state></div> (renderizza lo stato corrente come JSON)","@log":"Esempio: <div @log></div> (mostra il log delle direttive sull'elemento)","@hover":'Esempio: <div @hover="doSomething()"></div>',no:"Esempio: <no>{{nome}}</no> (mostra contenuto senza interpolazione)","@text:hover":"Esempio: <div @text:hover=\"'Testo hover'\"></div>","@text:click":"Esempio: <div @text:click=\"'Testo click'\"></div>","@text:input":'Esempio: <input @text:input="nome">',"@text:focus":'Esempio: <input @text:focus="nome">',"@class:focus":'Esempio: <input @class:focus="{rosso:true}">',"@class:hover":'Esempio: <div @class:hover="{rosso: condizione}"></div>',"@class:click":'Esempio: <div @class:click="{rosso: condizione}"></div>',"@class:input":'Esempio: <input @class:input="{rosso: condizione}">',"@class:change":'Esempio: <input @class:change="{rosso: condizione}">',"@fetch:click":'Esempio: <button @fetch:click="\'url\'" @result="data"></button>',"@fetch:hover":'Esempio: <button @fetch:hover="\'url\'" @result="data"></button>',"@fetch:input":'Esempio: <input @fetch:input="\'url\'" @result="data">',"@fetch:change":'Esempio: <input @fetch:change="\'url\'" @result="data">',"@model:input":'Esempio: <input @model:input="nome">',"@model:change":'Esempio: <input @model:change="nome">',"@model:focus":'Esempio: <input @model:focus="nome">',"@model:blur":'Esempio: <input @model:blur="nome">',"@set:change":"Esempio: <input @set:change=\"foo='bar'\">","@set:click":'Esempio: <button @set:click="foo=1"></button>',"@set:input":"Esempio: <input @set:input=\"foo='bar'\">","@set:focus":"Esempio: <input @set:focus=\"foo='bar'\">","@set:blur":"Esempio: <input @set:blur=\"foo='bar'\">","@focus":'Esempio: <input @focus="doSomething()">',"@blur":'Esempio: <input @blur="doSomething()">',"@change":'Esempio: <input @change="doSomething()">',"@input":'Esempio: <input @input="doSomething()">'}}getHelp(t){return this.helpTexts[t]||""}isValidDirective(t){return this.helpTexts.hasOwnProperty(t)}}class o{constructor(t){this.evaluator=t,this.startTime=performance.now()}getBaseInfo(t,e){return{tag:t.tag,timestamp:new Date,executionTime:(performance.now()-this.startTime).toFixed(2)+"ms"}}log(t,e,s){return this.getBaseInfo(t,e)}}class c extends o{log(t,e,s){const i=super.log(t,e,s),r=t.directives["@for"];let n={};try{const t=r.match(/(\w+),\s*(\w+) in (.+)/),s=r.match(/(\w+) in (.+)/);if(t||s){const i=t?t[3]:s[2],a=t?t[2]:s[1],o=t?t[1]:null,c=this.evaluator.evalExpr(i,e),l=Array.isArray(c),d=l?c.length:c?Object.keys(c).length:0;n={expression:r,arrayVariable:i,itemVariable:a,indexVariable:o,arrayType:l?"Array":"Object",length:d,isEmpty:0===d,firstItem:d>0?c[0]:null,status:0===d?"❌ Empty":`✅ ${d} items`,performance:`${d} items rendered`}}}catch(t){n={expression:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...i,type:"@for",data:n}}}class l extends o{constructor(t,e){super(t),this.fetchManager=e}log(t,e,s){const i=super.log(t,e,s),r=t.directives["@fetch"],n=t.directives["@result"]||"result";let a={};try{let t=this.evaluator.evalExpr(r,e);t||(t=r);const i=s[n],o=this.fetchManager.fetched[t]?.error,c=this.fetchManager.pendingFetches[`${t}::${n}`];a={url:t,method:"GET",resultVariable:n,status:o?`❌ ${o}`:c?"⏳ Loading...":i?"✅ Success":"⭕ No data",responseSize:i?`${JSON.stringify(i).length} chars`:"N/A",hasData:!!i,hasError:!!o,isPending:!!c,lastFetch:this.fetchManager.lastFetchUrl[n]?"Recently":"Never"}}catch(t){a={url:r,error:`❌ ${t.message}`,status:"❌ Error evaluating URL"}}return{...i,type:"@fetch",data:a}}}class d extends o{log(t,e,s){const i=super.log(t,e,s),r=t.directives["@model"],n=t.directives["@validate"];let a={};try{const t=this.evaluator.evalExpr(r,e),i=s._validate?.[r];a={variable:r,currentValue:t,valueType:typeof t,isEmpty:!t||""===t,validation:n?{rules:n,isValid:i,status:i?"✅ Valid":"❌ Invalid"}:null,binding:"✅ Active"}}catch(t){a={variable:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...i,type:"@model",data:a}}}class h extends o{log(t,e,s){const i=super.log(t,e,s),r=t.directives["@if"]||t.directives["@show"]||t.directives["@hide"],n=t.directives["@if"]?"@if":t.directives["@show"]?"@show":"@hide";let a={};try{const t=this.evaluator.evalExpr(r,e),s="@hide"===n?!t:!!t;a={condition:r,result:t,isVisible:s,status:s?"✅ Visible":"❌ Hidden",evaluation:`${r} → ${t}`}}catch(t){a={condition:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...i,type:n,data:a}}}class u extends o{constructor(t){super(t),this.clickCount=0,this.lastClick=null}log(t,e,s){return{...super.log(t,e,s),type:"@click",data:{action:t.directives["@click"],clickCount:this.clickCount,lastClick:this.lastClick?Date.now()-this.lastClick+"ms ago":"Never",status:"✅ Ready"}}}recordClick(){this.clickCount++,this.lastClick=Date.now()}}class p extends o{constructor(t){super(t),this.inputCount=0,this.lastInput=null}log(t,e,s){return{...super.log(t,e,s),type:"@input",data:{action:t.directives["@input"],inputCount:this.inputCount,lastInput:this.lastInput?Date.now()-this.lastInput+"ms ago":"Never",status:"✅ Ready"}}}recordInput(){this.inputCount++,this.lastInput=Date.now()}}class g extends o{constructor(t){super(t),this.focusCount=0,this.lastFocus=null}log(t,e,s){return{...super.log(t,e,s),type:"@focus",data:{action:t.directives["@focus"],focusCount:this.focusCount,lastFocus:this.lastFocus?Date.now()-this.lastFocus+"ms ago":"Never",status:"✅ Ready"}}}recordFocus(){this.focusCount++,this.lastFocus=Date.now()}}class v extends o{constructor(t){super(t),this.blurCount=0,this.lastBlur=null}log(t,e,s){return{...super.log(t,e,s),type:"@blur",data:{action:t.directives["@blur"],blurCount:this.blurCount,lastBlur:this.lastBlur?Date.now()-this.lastBlur+"ms ago":"Never",status:"✅ Ready"}}}recordBlur(){this.blurCount++,this.lastBlur=Date.now()}}class f extends o{constructor(t){super(t),this.changeCount=0,this.lastChange=null}log(t,e,s){return{...super.log(t,e,s),type:"@change",data:{action:t.directives["@change"],changeCount:this.changeCount,lastChange:this.lastChange?Date.now()-this.lastChange+"ms ago":"Never",status:"✅ Ready"}}}recordChange(){this.changeCount++,this.lastChange=Date.now()}}class m extends o{constructor(t,e){super(t),this.componentManager=e}log(t,e,s){const i=super.log(t,e,s),r=t.directives["@src"];let n={};try{let t=this.evaluator.evalExpr(r,e);if(!t){const e=r.trim();t=/^['"].*['"]$/.test(e)?e.slice(1,-1):e}const s=this.componentManager.getCachedComponent(t),i=this.componentManager.isLoading(t);n={source:t,status:i?"⏳ Loading...":s?"✅ Loaded":"⭕ Not loaded",cached:!!s,isLoading:i,size:s?`${s.length} chars`:"N/A"}}catch(t){n={source:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...i,type:"@component",data:n}}}class b{constructor(){this.logs=[],this.loggers={},this.clickLoggers=new WeakMap,this.startTime=performance.now(),this.maxLogs=100}initializeLoggers(t,e,s){this.loggers={"@for":new c(t),"@fetch":new l(t,e),"@model":new d(t),"@if":new h(t),"@show":new h(t),"@hide":new h(t),"@click":new u(t),"@component":new m(t,s),"@input":new p(t),"@focus":new g(t),"@blur":new v(t),"@change":new f(t)}}addLog(t,e,s,i,r=null){if(!this.loggers||0===Object.keys(this.loggers).length)return;const n=performance.now(),a={id:Date.now()+Math.random(),timestamp:new Date,tag:e.tag,type:"multi-directive",elementInfo:t,executionTime:(performance.now()-n).toFixed(2)+"ms",directives:[]};Object.keys(e.directives).forEach((t=>{if(this.loggers[t])try{const r=this.loggers[t].log(e,s,i);a.directives.push({type:t,data:r.data,status:this._getDirectiveStatus(r.data)})}catch(e){a.directives.push({type:t,data:{error:e.message,status:"❌ Error logging"},status:"error"})}else a.directives.push({type:t,data:{expression:e.directives[t],status:"📋 Untracked directive"},status:"unknown"})})),Object.entries(e.subDirectives||{}).forEach((([t,r])=>{Object.keys(r).forEach((n=>{if(this.loggers[t])try{const r=this.loggers[t].log(e,s,i);a.directives.push({type:`${t}:${n}`,data:r.data,status:this._getDirectiveStatus(r.data),isSubDirective:!0})}catch(e){a.directives.push({type:`${t}:${n}`,data:{error:e.message,status:"❌ Error logging"},status:"error",isSubDirective:!0})}else a.directives.push({type:`${t}:${n}`,data:{expression:r[n],status:"📋 Untracked sub-directive"},status:"unknown",isSubDirective:!0})}))})),0===a.directives.length&&(a.type="generic",a.directives.push({type:"generic",data:{message:"Element with @log but no tracked directives",status:"📋 Generic log"},status:"generic"})),a.overallStatus=this._calculateOverallStatus(a.directives),this.logs.unshift(a),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs))}_getDirectiveStatus(t){return t.error?"error":t.isPending||t.isLoading?"loading":t.status&&t.status.includes("✅")?"success":t.status&&t.status.includes("❌")?"error":t.status&&t.status.includes("⏳")?"loading":"normal"}_calculateOverallStatus(t){if(!t||0===t.length)return"📊 No directives";const e=t.map((t=>t.status));return e.includes("error")?"❌ Has Errors":e.includes("loading")?"⏳ Loading":e.every((t=>"success"===t))?"✅ All Good":"📊 Mixed Status"}recordClick(t){const e=this.clickLoggers.get(t);e&&e.recordClick()}_getDirectiveColor(t){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4","@input":"#e91e63","@focus":"#3f51b5","@blur":"#607d8b","@change":"#795548",generic:"#666666"}[t]||"#666666"}_generateIntelligentLogHTML(t){const e=t.timestamp.toLocaleTimeString();if("multi-directive"===t.type){let s=`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #66ccff; font-weight: bold;">🎯 &lt;${t.tag}&gt; (${t.directives.length} directives)</span>\n            <span style="color: #999; font-size: 10px;">${e}</span>\n          </div>\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #ffcc66; font-size: 10px;">⏱️ ${t.executionTime}</span>\n            <span style="color: ${this._getStatusColor(t.overallStatus)}; font-size: 10px; font-weight: bold;">${t.overallStatus}</span>\n          </div>\n        `;return t.directives.forEach(((t,e)=>{const i=this._getDirectiveColor(t.type),r=this._getStatusColor(t.status);s+=`\n            <div style="border-left: 3px solid ${i}; margin: 6px 0; padding: 6px 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <span style="color: ${i}; font-weight: bold; font-size: 11px;">\n                  ${t.isSubDirective?"📎":"📋"} ${t.type}\n                </span>\n                <span style="color: ${r}; font-size: 9px;">${this._getStatusIcon(t.status)}</span>\n              </div>\n              ${this._generateCompactDirectiveHTML(t.type,t.data)}\n            </div>\n          `})),s}return'<div style="color: #cccccc;">Generic log entry</div>'}_getStatusColor(t){if(!t)return"#cccccc";if("string"==typeof t){if(t.includes("error")||t.includes("❌"))return"#ff6b6b";if(t.includes("loading")||t.includes("⏳"))return"#ffa726";if(t.includes("success")||t.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(t){return t?"error"===t?"❌":"loading"===t?"⏳":"success"===t?"✅":"unknown"===t?"❓":"📊":"📊"}_generateCompactDirectiveHTML(t,e){if(!e)return'<div style="color: #999;">No data available</div>';let s="";try{switch(t.split(":")[0]){case"@for":s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Array: <strong>${e.arrayVariable||"unknown"}</strong> (${e.length||0} items)<br>\n                Status: ${e.status||"unknown"}\n              </div>\n            `;break;case"@fetch":const t=e.url||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                URL: <strong>${t.slice(0,40)}${t.length>40?"...":""}</strong><br>\n                Status: ${e.status||"unknown"} | Size: ${e.responseSize||"N/A"}\n              </div>\n            `;break;case"@model":const i=e.currentValue,r="string"==typeof i?`"${i.slice(0,20)}${i.length>20?"...":""}"`:JSON.stringify(i);s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Variable: <strong>${e.variable||"unknown"}</strong><br>\n                Value: ${r} | ${e.validation?.status||"No validation"}\n              </div>\n            `;break;case"@if":case"@show":case"@hide":const n=e.condition||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Condition: <strong>${n.slice(0,30)}${n.length>30?"...":""}</strong><br>\n                Result: ${e.result} → ${e.isVisible?"Visible":"Hidden"}\n              </div>\n            `;break;case"@click":const a=e.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${a.slice(0,30)}${a.length>30?"...":""}</strong><br>\n                Clicks: ${e.clickCount||0} | Last: ${e.lastClick||"Never"}\n              </div>\n            `;break;case"@component":const o=e.source||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Source: <strong>${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n                Status: ${e.status||"unknown"} | Cached: ${e.cached?"Yes":"No"}\n              </div>\n            `;break;case"@input":const c=e.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${c.slice(0,30)}${c.length>30?"...":""}</strong><br>\n                Inputs: ${e.inputCount||0} | Last: ${e.lastInput||"Never"}\n              </div>\n            `;break;case"@focus":const l=e.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${l.slice(0,30)}${l.length>30?"...":""}</strong><br>\n                Focus events: ${e.focusCount||0} | Last: ${e.lastFocus||"Never"}\n              </div>\n            `;break;case"@blur":const d=e.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${d.slice(0,30)}${d.length>30?"...":""}</strong><br>\n                Blur events: ${e.blurCount||0} | Last: ${e.lastBlur||"Never"}\n              </div>\n            `;break;case"@change":const h=e.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${h.slice(0,30)}${h.length>30?"...":""}</strong><br>\n                Change events: ${e.changeCount||0} | Last: ${e.lastChange||"Never"}\n              </div>\n            `;break;default:const u=e.expression||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Expression: <strong>${u.slice(0,40)}${u.length>40?"...":""}</strong><br>\n                Status: ${e.status||"unknown"}\n              </div>\n            `}e.error&&(s+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px;">💥 ${e.error}</div>`)}catch(t){s=`<div style="color: #ff6b6b; font-size: 9px;">Error rendering directive data: ${t.message}</div>`}return s}}class y{showAyishaError(t,e,s){if(!t)return;let i=t.parentNode&&t.parentNode.querySelector(".ayisha-error-banner");i?i.innerHTML=`<b>Errore JS:</b> ${e.message}<br><code>${s}</code>`:(i=document.createElement("div"),i.className="ayisha-error-banner",i.style.background="#c00",i.style.color="#fff",i.style.padding="0.5em 1em",i.style.margin="0.5em 0",i.style.borderRadius="4px",i.style.fontWeight="bold",i.style.border="1px solid #900",i.style.position="relative",i.style.zIndex="1000",i.innerHTML=`<b>Errore JS:</b> ${e.message}<br><code>${s}</code>`,t.parentNode&&t.parentNode.insertBefore(i,t.nextSibling))}createErrorElement(t){const e=document.createElement("div");return e.className="ayisha-directive-error",e.style.background="#c00",e.style.color="#fff",e.style.padding="1em",e.style.margin="0.5em 0",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.border="1px solid #900",e.innerHTML=t,e}createWarningElement(t){const e=document.createElement("div");return e.className="ayisha-directive-warning",e.style.background="#ffeb3b",e.style.color="#333",e.style.padding="1em",e.style.margin="0.5em 0",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.border="1px solid #e0c200",e.innerHTML=t,e}}class x{constructor(t,e){this.evaluator=t,this.renderCallback=e,this.modelBindings=[]}bindModel(t,e,s){let i=null;function r(t,e,s){if(t.includes(".")){const i=t.split("."),r=i[0];return e&&"object"==typeof e[r]&&null!==e[r]?{root:e[r],path:i.slice(1)}:{root:s,path:i}}return e&&"object"==typeof e[t]&&null!==e[t]?{root:e[t],path:[]}:{root:s,path:[t]}}"number"===t.type?i="number":"checkbox"===t.type&&(i="checkbox");const{root:n,path:a}=r(e,s,this.evaluator.state);let o=n;if(a.length>0){for(let t=0;t<a.length-1;t++)"object"==typeof o[a[t]]&&null!==o[a[t]]||(o[a[t]]={}),o=o[a[t]];const e=a[a.length-1];"number"===t.type?"number"!=typeof o[e]&&(o[e]=0):"checkbox"===t.type?"boolean"!=typeof o[e]&&(o[e]=!1):"string"!=typeof o[e]&&(o[e]="")}else"object"==typeof o&&null!==o||("number"===t.type?"number"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=0):"checkbox"===t.type?"boolean"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=!1):"string"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=""));const c=()=>{const i=this.evaluator.evalExpr(e,s);if("checkbox"===t.type)t.checked=!!i;else if("radio"===t.type)t.checked=i==t.value;else if("color"===t.type)i&&"string"==typeof i&&i.match(/^#[0-9A-Fa-f]{6}$/)?t.value=i:i&&"string"==typeof i&&i.match(/^[0-9A-Fa-f]{6}$/)?t.value="#"+i:t.value="#000000";else{const e=null==i?"":String(i);t.value!==e&&(t.value=e)}};this.modelBindings.push({el:t,update:c}),c();const l=()=>{let i=null;"number"===t.type?i="number":"checkbox"===t.type&&(i="checkbox");const{root:n,path:a}=r(e,s,this.evaluator.state);let o,c=n;if(o="checkbox"===t.type?t.checked:"number"===t.type?""===t.value?void 0:Number(t.value):t.value,a.length>0){for(let t=0;t<a.length-1;t++)"object"==typeof c[a[t]]&&null!==c[a[t]]||(c[a[t]]={}),c=c[a[t]];c[a[a.length-1]]=o}else"object"==typeof c&&null!==c||(this.evaluator.state[e]=o);this.renderCallback()};"checkbox"===t.type||"radio"===t.type?t.addEventListener("change",l):t.addEventListener("input",l)}bindValidation(t,e,s=null){const i=[];let r="",n=!1;for(let t=0;t<e.length;t++){const s=e[t];"^"!==s||n?"$"===s&&n?(n=!1,r+=s,i.push(r.trim()),r=""):","!==s||n?r+=s:(r.trim()&&i.push(r.trim()),r=""):(n=!0,r+=s)}if(r.trim()&&i.push(r.trim()),!s)return;this.evaluator.state._validate||(this.evaluator.state._validate={}),this.evaluator.state._validate[s]=!1;const a=()=>{let e=!0;for(const s of i)if(/^\^.*\$$/.test(s))try{const i=new RegExp(s);if(!i.test(t.value||"")){e=!1;break}}catch(t){e=!1;break}else if("required"===s){if(!t.value||!t.value.trim()){e=!1;break}}else if(s.startsWith("minLength:")){const i=parseInt(s.split(":")[1],10);if(t.value.length<i){e=!1;break}}else if(s.startsWith("maxLength:")){const i=parseInt(s.split(":")[1],10);if(t.value.length>i){e=!1;break}}else if(s.startsWith("min:")){const i=parseFloat(s.split(":")[1]),r=parseFloat(t.value);if(isNaN(r)||r<i){e=!1;break}}else if(s.startsWith("max:")){const i=parseFloat(s.split(":")[1]),r=parseFloat(t.value);if(isNaN(r)||r>i){e=!1;break}}else if("email"===s){if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t.value||"")){e=!1;break}}else if("phone"===s){if(!/^\+\d{1,3}\s?\d{3,4}\s?\d{3,4}\s?\d{3,4}$/.test(t.value||"")){e=!1;break}}else if("password"===s){if(!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(t.value||"")){e=!1;break}}else if(s.startsWith("regex:")){let i=s.slice(6);try{if(!new RegExp(i).test(t.value||"")){e=!1;break}}catch(t){e=!1;break}}return this.evaluator.state._validate[s]=e,t.classList.toggle("invalid",!e),t.classList.toggle("valid",e&&t.value.length>0),e};a(),t.addEventListener("input",(()=>{a(),this.renderCallback()})),t.addEventListener("blur",a)}updateBindings(){this.modelBindings.forEach((t=>t.update()))}clearBindings(){this.modelBindings=[]}}class w{static version="1.0.0";constructor(o=document.body){this.root=o,this.state={},this._initBlocks=[],this._vdom=null,this._isRendering=!1,this._processedSetDirectives=new Set,this._componentRenderTimeout=null,this.evaluator=new t(this.state),this.parser=new e(this._initBlocks),this.componentManager=new s,this.reactivitySystem=new i(this.state,(()=>this.render())),this.router=new r(this.state,(()=>this.render())),this.fetchManager=new n(this.evaluator),this.helpSystem=new a,this.errorHandler=new y,this.bindingManager=new x(this.evaluator,(()=>this.render())),this.centralLogger=new b,this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager),window.ayisha=this}component(t,e){this.componentManager.component(t,e)}addWatcher(t,e){this.reactivitySystem.addWatcher(t,e)}directiveHelp(t){return this.helpSystem.getHelp(t)}parse(t){return this.parser.parse(t)}_runInitBlocks(){if(this._isRendering)return;this._initBlocks.forEach((t=>{if(!t||!t.trim())return;const e=t.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();try{new Function("state",e)(this.state)}catch(t){}}));["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"].forEach((t=>{t in this.state&&delete this.state[t]}));Object.keys(this.state).forEach((t=>{/[+\-*\/=<>!&|(){}[\].,\s]|=>|==|!=|<=|>=|\|\||&&/.test(t)&&delete this.state[t]}));["_validate","_currentPage","_version","_locale"].forEach((t=>{t in this.state||("_validate"===t?this.state[t]={}:"_currentPage"===t?this.state[t]="":"_version"===t?this.state[t]=w.version:"_locale"===t&&(this.state[t]=navigator.language||navigator.userLanguage||"en"))}))}_preInitializeEssentialVariables(){this.state._validate||(this.state._validate={}),this.state._currentPage||(this.state._currentPage=""),this.state._version||(this.state._version=w.version),this.state._locale||(this.state._locale=navigator.language||navigator.userLanguage||"en")}_makeReactive(){this.state=this.reactivitySystem.makeReactive(),this.evaluator.state=this.state,this.fetchManager.evaluator.state=this.state}_setupRouting(){this.router.setupRouting()}_findFirstPageDirective(t){if(!t)return null;if(t.directives&&t.directives["@page"])return t;if(t.children&&t.children.length)for(const e of t.children){const t=this._findFirstPageDirective(e);if(t)return t}return null}async preloadComponents(){const t=[],e=new Set;if(this.root.querySelectorAll("component").forEach((s=>{let i=null;if(s.hasAttribute("src"))i=s.getAttribute("src");else if(s.hasAttribute("@src")){const t=s.getAttribute("@src");if(/^['\"].*['\"]$/.test(t))i=t.slice(1,-1);else try{i=this.evaluator.evalExpr(t)}catch(e){(t.includes(".html")||t.startsWith("./"))&&(i=t)}}!i||e.has(i)||this.componentManager.getCachedComponent(i)||(e.add(i),t.push(this.componentManager.loadExternalComponent(i)))})),t.length>0)try{const e=await Promise.allSettled(t);e.filter((t=>"fulfilled"===t.status)).length,e.filter((t=>"rejected"===t.status)).length}catch(t){}}render(){if(this._isRendering)return;this._isRendering=!0;const t=window.scrollX,e=window.scrollY,s=document.activeElement;let i=null;if(s&&("INPUT"===s.tagName||"TEXTAREA"===s.tagName)){const t=[];let e=s;for(;e&&e!==this.root;){const s=e.parentNode;t.unshift([...s.childNodes].indexOf(e)),e=s}i={path:t,start:s.selectionStart,end:s.selectionEnd,type:s.type}}this.bindingManager.clearBindings();const r=this._renderVNode(this._vdom,this.state);if(this.root===document.body?(document.body.innerHTML="",r&&(void 0===r.tagName&&r.childNodes?Array.from(r.childNodes).forEach((t=>document.body.appendChild(t))):(DocumentFragment,document.body.appendChild(r)))):(this.root.innerHTML="",r&&(void 0===r.tagName&&r.childNodes?Array.from(r.childNodes).forEach((t=>this.root.appendChild(t))):(DocumentFragment,this.root.appendChild(r)))),i){let t=this.root;if(i.path.forEach((e=>t=t.childNodes[e])),t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName)){t.focus();try{("INPUT"===t.tagName&&"number"==typeof t.selectionStart&&"function"==typeof t.setSelectionRange&&"number"!==t.type||"TEXTAREA"===t.tagName)&&t.setSelectionRange(i.start,i.end)}catch(t){}}}this._addLogIndicators(),window.scrollTo(t,e),this.bindingManager.updateBindings(),this._isRendering=!1}_addLogIndicators(){this.root.querySelectorAll('[data-ayisha-log="true"]').forEach((t=>{const e=t.nextElementSibling;e&&e.classList.contains("ayisha-log-display")&&e.remove();try{const e=JSON.parse(t.getAttribute("data-ayisha-log-info")||"{}"),s=document.createElement("div");s.className="ayisha-log-display",s.style.cssText="\n            background: rgba(0, 20, 40, 0.95) !important;\n            color: #fff !important;\n            padding: 8px 12px !important;\n            margin: 4px 0 !important;\n            border-radius: 6px !important;\n            font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n            font-size: 11px !important;\n            border-left: 4px solid #0066cc !important;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n            max-width: 400px !important;\n            overflow-x: auto !important;\n            line-height: 1.4 !important;\n          ";const i=this._generateInlineLogContent(t,e);s.innerHTML=i,t.parentNode&&t.parentNode.insertBefore(s,t.nextSibling)}catch(t){}}));this.root.querySelectorAll("[data-ayisha-log-error]").forEach((t=>{const e=t.getAttribute("data-ayisha-log-error"),s=document.createElement("div");s.className="ayisha-log-error-display",s.style.cssText="\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        ",s.innerHTML=`❌ Log Error: ${e}`,t.parentNode&&t.parentNode.insertBefore(s,t.nextSibling)}))}_generateInlineLogContent(t,e){const s={tag:e.tag||t.tagName.toLowerCase(),directives:e.directives||{},subDirectives:e.subDirectives||{}},i={};let r=`<div style="color: #66ccff; font-weight: bold; margin-bottom: 6px;">📊 &lt;${s.tag}&gt;</div>`,n=!1,a=0;if(Object.keys(s.directives).forEach((t=>{if("@log"!==t)if(a++,this.centralLogger.loggers[t]){n=!0;try{const e=this.centralLogger.loggers[t].log(s,i,this.state);r+=this._formatDirectiveLog(t,e.data)}catch(e){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n              <span style="color: #ff9999;">${t}</span>: \n              <span style="color: #ffcccc;">❌ ${e.message}</span>\n            </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n            <span style="color: #ccc;">${t}</span>: \n            <span style="color: #aaa;">${this._truncateValue(s.directives[t])}</span>\n            <span style="color: #777; font-size: 10px;"> [untracked]</span>\n          </div>`})),Object.entries(s.subDirectives||{}).forEach((([t,e])=>{Object.keys(e).forEach((o=>{a++;const c=`${t}:${o}`;if(this.centralLogger.loggers[t]){n=!0;try{const e=this.centralLogger.loggers[t].log(s,i,this.state);r+=this._formatDirectiveLog(c,e.data,!0)}catch(t){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n                <span style="color: #ff9999;">${c}</span>: \n                <span style="color: #ffcccc;">❌ ${t.message}</span>\n              </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n              <span style="color: #ccc;">${c}</span>: \n              <span style="color: #aaa;">${this._truncateValue(e[o])}</span>\n              <span style="color: #777; font-size: 10px;"> [untracked]</span>\n            </div>`}))})),0===a?r+='<div style="color: #ff9966; font-style: italic; margin: 4px 0;">\n          ⚠️ Element has @log but no other directives\n        </div>':n||(r+=`<div style="color: #ffa726; font-style: italic; margin: 4px 0;">\n          Found ${a} directive(s) but none are tracked by loggers\n        </div>`),e.elementInfo){const t=e.elementInfo;(t.className||t.id)&&(r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; padding-top: 2px; border-top: 1px solid #333;">\n            ${t.className?`Class: ${t.className}`:""}${t.className&&t.id?" | ":""}${t.id?`ID: ${t.id}`:""}\n          </div>`)}return r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; border-top: 1px solid #333; padding-top: 2px;">\n        ${(new Date).toLocaleTimeString()}\n      </div>`,r}_formatDirectiveLog(t,e,s=!1){const i=s?"📎":"📋";let r='<div style="margin: 4px 0; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 3px;">';if(r+=`<div style="color: ${this._getDirectiveColor(t.split(":")[0])}; font-weight: bold; font-size: 11px; margin-bottom: 2px;">\n        ${i} ${t}\n      </div>`,!e)return r+='<div style="color: #999;">No data available</div>',r+="</div>",r;switch(t.split(":")[0]){case"@for":r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Array: <strong style="color: #ffcc66;">${e.arrayVariable||"unknown"}</strong> (${e.length||0} items)<br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Item var: <span style="color: #66ccff;">${e.itemVariable||"unknown"}</span>\n            ${e.indexVariable?`, Index var: <span style="color: #66ccff;">${e.indexVariable}</span>`:""}\n          </div>`;break;case"@fetch":const t=e.url||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            URL: <strong style="color: #66ff66;">${t.slice(0,35)}${t.length>35?"...":""}</strong><br>\n            Result var: <span style="color: #ffcc66;">${e.resultVariable||"result"}</span><br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Size: <span style="color: #ccc;">${e.responseSize||"N/A"}</span>\n          </div>`;break;case"@model":const s=e.currentValue,i="string"==typeof s?`"${s.slice(0,20)}${s.length>20?"...":""}"`:JSON.stringify(s);r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Variable: <strong style="color: #66ccff;">${e.variable||"unknown"}</strong><br>\n            Value: <span style="color: #ffcc66;">${i}</span> \n            <span style="color: #999;">(${e.valueType})</span><br>\n            ${e.validation?`Validation: <span style="color: ${this._getStatusColor(e.validation.status)};">${e.validation.status}</span>`:"No validation"}\n          </div>`;break;case"@if":case"@show":case"@hide":const n=e.condition||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Condition: <strong style="color: #ffcc66;">${n.slice(0,25)}${n.length>25?"...":""}</strong><br>\n            Result: <span style="color: #66ccff;">${e.result}</span> → \n            <span style="color: ${e.isVisible?"#66bb6a":"#ff6b6b"};">${e.isVisible?"Visible":"Hidden"}</span>\n          </div>`;break;case"@click":const a=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${a.slice(0,25)}${a.length>25?"...":""}</strong><br>\n            Clicks: <span style="color: #66ccff;">${e.clickCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastClick||"Never"}</span>\n          </div>`;break;case"@component":const o=e.source||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Source: <strong style="color: #66ccff;">${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Cached: <span style="color: ${e.cached?"#66bb6a":"#ff9800"};">${e.cached?"Yes":"No"}</span>\n          </div>`;break;case"@input":const c=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${c.slice(0,25)}${c.length>25?"...":""}</strong><br>\n            Inputs: <span style="color: #66ccff;">${e.inputCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastInput||"Never"}</span>\n          </div>`;break;case"@focus":const l=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${l.slice(0,25)}${l.length>25?"...":""}</strong><br>\n            Focus events: <span style="color: #66ccff;">${e.focusCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastFocus||"Never"}</span>\n          </div>`;break;case"@blur":const d=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${d.slice(0,25)}${d.length>25?"...":""}</strong><br>\n            Blur events: <span style="color: #66ccff;">${e.blurCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastBlur||"Never"}</span>\n          </div>`;break;case"@change":const h=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${h.slice(0,25)}${h.length>25?"...":""}</strong><br>\n            Change events: <span style="color: #66ccff;">${e.changeCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastChange||"Never"}</span>\n          </div>`;break;default:r+=`<div style="color: #cccccc; font-size: 10px;">\n            Expression: <span style="color: #ffcc66;">${e.expression||"N/A"}</span><br>\n            Status: <span style="color: #999;">${e.status||"unknown"}</span>\n          </div>`}return e.error&&(r+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px; padding: 2px; background: rgba(255,0,0,0.1); border-radius: 2px;">\n          💥 ${e.error}\n        </div>`),r+="</div>",r}_getDirectiveColor(t){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4",generic:"#666666"}[t]||"#666666"}_getStatusColor(t){if(!t)return"#cccccc";if("string"==typeof t){if(t.includes("error")||t.includes("❌"))return"#ff6b6b";if(t.includes("loading")||t.includes("⏳"))return"#ffa726";if(t.includes("success")||t.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(t){return t?"error"===t?"❌":"loading"===t?"⏳":"success"===t?"✅":"unknown"===t?"❓":"📊":"📊"}_truncateValue(t,e=30){return"string"!=typeof t&&(t=String(t)),t.length>e?t.slice(0,e)+"...":t}_renderVNode(t,e){if(!t)return null;if(t.directives&&void 0!==t.directives["@page"]&&this.state._currentPage!==t.directives["@page"])return null;Object.entries(t.directives||{}).forEach((([t,e])=>{/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e.trim())&&("@model"===t?this.evaluator.ensureVarInState(e,!0):this.evaluator.ensureVarInState(e))})),Object.values(t.subDirectives||{}).forEach((t=>Object.values(t).forEach((t=>{/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t.trim())&&this.evaluator.ensureVarInState(t)}))));let s=null,i=null,r=null;if(t&&t.directives)for(const e of Object.keys(t.directives))if(("@src"!==e||"component"!==t.tag)&&!this.helpSystem.isValidDirective(e)){s=e;break}if(!s&&t&&t.subDirectives)for(const[e,s]of Object.entries(t.subDirectives)){for(const t of Object.keys(s)){const s=`${e}:${t}`;if(!this.helpSystem.isValidDirective(s)){i=e,r=t;break}}if(i)break}if(s||i){let t="";if(s)t=`Error: Unknown directive <b>${s}</b>.`,t+="<br>"+this.directiveHelp(s);else{const e=`${i}:${r}`;t=`Error: Unknown sub-directive <b>${e}</b>.`,t+="<br>"+this.directiveHelp(e)}return this.errorHandler.createErrorElement(t)}if("text"===t.type)return document.createTextNode(this.evaluator.evalText(t.text,e));if("fragment"===t.tag){const s=document.createDocumentFragment();return t.children.forEach((t=>{const i=this._renderVNode(t,e);i&&s.appendChild(i)})),s}if(t.directives["@if"]&&!this.evaluator.evalExpr(t.directives["@if"],e))return null;if(t.directives["@show"]&&!this.evaluator.evalExpr(t.directives["@show"],e))return null;if(t.directives["@hide"]&&this.evaluator.evalExpr(t.directives["@hide"],e))return null;if(t.directives["@for"])return this._handleForDirective(t,e);if(t.directives["@switch"])return this._handleSwitchDirective(t,e);if(t.directives["@source"])return this._handleFunctionalDirectives(t,e);if("component"===t.tag)return this._handleComponentDirective(t,e);if("no"===t.tag)return this._handleNoDirective(t,e);const n=document.createElement(t.tag);return Object.entries(t.attrs).forEach((([t,s])=>{n.setAttribute(t,this.evaluator.evalAttrValue(s,e))})),this._handleSpecialDirectives(n,t,e),this._handleStandardDirectives(n,t,e),t.children.forEach((t=>{const s=this._renderVNode(t,e);s&&n.appendChild(s)})),this._handleSubDirectives(n,t,e),n}_handleForDirective(t,e){let s=t.directives["@for"].match(/(\w+),\s*(\w+) in (.+)/);if(s){const[,i,r,n]=s;let a=this.evaluator.evalExpr(n,e)||[];"object"!=typeof a||Array.isArray(a)||(a=Object.values(a));const o=document.createDocumentFragment();return a.forEach(((s,a)=>{const c=JSON.parse(JSON.stringify(t));delete c.directives["@for"];const l={...e,[r]:s,[i]:a,[`${r}_index`]:a,[`${r}_ref`]:`${n.split(".")[0]}[${a}]`},d=this._renderVNode(c,l);d&&o.appendChild(d)})),o}if(s=t.directives["@for"].match(/(\w+) in (.+)/),s){const[,i,r]=s;let n=this.evaluator.evalExpr(r,e)||[];"object"!=typeof n||Array.isArray(n)||(n=Object.values(n));const a=r.split(".")[0],o=r.includes(".filter"),c=document.createDocumentFragment();return n.forEach(((s,r)=>{const n=JSON.parse(JSON.stringify(t));delete n.directives["@for"];let l=r;o&&this.state[a]&&(l=this.state[a].findIndex((t=>t.id===s.id||JSON.stringify(t)===JSON.stringify(s))));const d={...e,[i]:s,$index:r,$originalIndex:l,$arrayName:a},h=this._renderVNode(n,d);h&&c.appendChild(h)})),c}return null}_handleSwitchDirective(t,e){const s=this.evaluator.evalExpr(t.directives["@switch"],e);let i=null;for(const r of t.children)if(r.directives){if(null!=r.directives["@case"]){let t=r.directives["@case"];if(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),String(t)===String(s))return this._renderVNode(r,e)}null!=r.directives["@default"]&&(i=r)}return i?this._renderVNode(i,e):document.createComment("noswitch")}_handleFunctionalDirectives(t,e){let s=this.evaluator.evalExpr(t.directives["@source"],e),i=[];i=Array.isArray(s)?s:s&&"object"==typeof s?Object.values(s):null==s?[]:[s];const r=(t,e)=>{JSON.stringify(this.state[t])!==JSON.stringify(e)&&Object.defineProperty(this.state,t,{value:e,writable:!0,configurable:!0,enumerable:!0})};let n=!1;if(t.directives["@map"]){n=!0;try{const e=t.directives["@map"];let s;if(e.includes("=>")){const[t,i]=e.split("=>").map((t=>t.trim()));s=new Function(t.trim(),`return (${i})`)}else s=new Function("item",`return (${e})`);const n=i.map(s);r(t.directives["@result"]||"result",n)}catch(e){r(t.directives["@result"]||"result",[])}}if(t.directives["@filter"]){n=!0;try{const e=t.directives["@filter"];let s;if(e.includes("=>")){const[t,i]=e.split("=>").map((t=>t.trim()));s=new Function(t.trim(),`return (${i})`)}else s=new Function("item",`return (${e})`);const n=i.filter(s);r(t.directives["@result"]||"result",n)}catch(e){r(t.directives["@result"]||"result",[])}}if(t.directives["@reduce"]){n=!0;try{const s=t.directives["@reduce"];let n;if(s.includes("=>")){const[t,e]=s.split("=>").map((t=>t.trim())),[i,r]=t.replace(/[()]/g,"").split(",").map((t=>t.trim()));n=new Function(i,r,`return (${e})`)}else n=new Function("acc","item",`return (${s})`);const a=t.directives["@initial"]?this.evaluator.evalExpr(t.directives["@initial"],e):void 0;let o;o=0===i.length?void 0!==a?a:void 0:void 0!==a?i.reduce(n,a):i.reduce(n),r(t.directives["@result"]||"result",o)}catch(s){const i=t.directives["@initial"]?this.evaluator.evalExpr(t.directives["@initial"],e):void 0;r(t.directives["@result"]||"result",void 0!==i?i:void 0)}}return n?document.createComment("functional"):null}_handleComponentDirective(t,e){if(!t.directives["@src"])return this.errorHandler.createErrorElement("Error: <b>&lt;component&gt;</b> requires the <b>@src</b> attribute");let s=null;try{s=this.evaluator.evalExpr(t.directives["@src"],e)}catch(t){}if(!s){const e=t.directives["@src"].trim();s=/^['\"].*['\"]$/.test(e)?e.slice(1,-1):e}if(!s||"undefined"===s||"null"===s)return this.errorHandler.createErrorElement("Error: Invalid component URL");if(s.startsWith("./")&&(s=s.substring(2)),this.componentManager.getCachedComponent(s)){const t=this.componentManager.getCachedComponent(s),i=document.createElement("div");i.innerHTML=t,this._processComponentInitBlocks(i);const r=this.parse(i);if(r&&r.children){const t=document.createDocumentFragment();return r.children.forEach((s=>{const i=this._renderVNode(s,e);i&&t.appendChild(i)})),t}}this.componentManager.getCachedComponent(s)||this.componentManager.loadExternalComponent(s).then((t=>{if(t){const e=document.createElement("div");e.innerHTML=t,this._processComponentInitBlocks(e),this._isRendering||(clearTimeout(this._componentRenderTimeout),this._componentRenderTimeout=setTimeout((()=>this.render()),10))}})).catch((t=>{this.componentManager.cache[s]=`<div class='component-error' style='padding: 10px; background: #ffe6e6; border: 1px solid #ff6b6b; border-radius: 4px; color: #d32f2f;'>Errore: ${t.message}</div>`,this._isRendering||(clearTimeout(this._componentRenderTimeout),this._componentRenderTimeout=setTimeout((()=>this.render()),10))}));const i=document.createElement("div");return i.className="component-loading",i.style.cssText="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; color: #6c757d; font-size: 14px; text-align: center;",i.innerHTML=`� Loading component: <code>${s}</code>`,i}_processComponentInitBlocks(t){const e=t.querySelectorAll("init"),s=[];e.forEach((t=>{const e=t.textContent.trim();e&&(this._initBlocks.includes(e)||(s.push(e),this._initBlocks.push(e))),t.remove()})),this._runInitBlocksImmediate(s)}_runInitBlocksImmediate(t){t.forEach((t=>{if(!t||!t.trim())return;const e=t.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();try{new Function("state",e)(this.state)}catch(t){}}))}_handleNoDirective(t,e){const s=document.createElement("span");if(void 0!==t.rawContent)s.textContent=t.rawContent;else{let e="";const i=t=>{if("string"==typeof t)return t;if("text"===t.type)return t.content||"";if(t.tag){let e="";t.attrs&&(e=Object.entries(t.attrs).map((([t,e])=>` ${t}="${e}"`)).join(""));let s="";t.directives&&(s=Object.entries(t.directives).map((([t,e])=>` ${t}="${e}"`)).join(""));let r="";t.subDirectives&&Object.entries(t.subDirectives).forEach((([t,e])=>{Object.entries(e).forEach((([e,s])=>{r+=` ${t}:${e}="${s}"`}))}));const n=t.children?t.children.map(i).join(""):"";return`<${t.tag}${e}${s}${r}>${n}</${t.tag}>`}return""};t.children&&t.children.length>0&&(e=t.children.map(i).join("")),s.textContent=e}return s}_handleSpecialDirectives(t,e,s){if(e.directives&&e.directives["@set"]){const i=e.directives["@set"],r=`${e.tag}-${JSON.stringify(e.attrs)}-${i}`;if(!this._processedSetDirectives.has(r)){this._processedSetDirectives.add(r);try{const t=e.directives["@set"];if(!this.evaluator.executeDirectiveExpression(t,s,null,!1)){const e=String(t).replace(/\bstate\./g,"");new Function("state","ctx",`with(state){with(ctx||{}){${e}}}`)(this.state,s)}}catch(e){t.setAttribute("data-ayisha-set-error",e.message)}}delete e.directives["@set"]}if(e.directives.hasOwnProperty("@state")){const e=document.createElement("div");e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.color="#fff",e.style.padding="1em",e.style.borderRadius="4px",e.style.marginTop="1em",e.style.overflow="auto";const s=document.createElement("h3");s.textContent="CURRENT STATE",s.style.margin="0.5em 0 2em",s.style.fontSize="1.1em",s.style.fontWeight="bold",s.style.color="#fff",e.appendChild(s);const i=document.createElement("pre");i.style.margin="0",i.style.whiteSpace="pre-wrap",i.style.fontFamily="monospace",i.textContent=JSON.stringify(this.state,null,2),e.appendChild(i),t.appendChild(e)}if(e.directives.hasOwnProperty("@log")){this.centralLogger&&this.centralLogger.loggers&&0!==Object.keys(this.centralLogger.loggers).length||this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager);try{const i={tagName:t.tagName,className:t.className,id:t.id};this.centralLogger.addLog(i,e,s,this.state,t);const r={tag:e.tag,directives:{...e.directives},subDirectives:{...e.subDirectives},elementInfo:i};if(t.setAttribute("data-ayisha-log","true"),t.setAttribute("data-ayisha-log-info",JSON.stringify(r)),e.directives["@click"]){const r=this.centralLogger.loggers["@click"];r&&(this.centralLogger.clickLoggers.set(t,r),t.addEventListener("click",(()=>{r.recordClick(),this.centralLogger.addLog(i,e,s,this.state,t)})))}}catch(e){t.setAttribute("data-ayisha-log-error",e.message)}}}_handleStandardDirectives(t,e,s){if(e.directives["@click"]&&t.addEventListener("click",(i=>{"BUTTON"===t.tagName&&i.preventDefault();const r=e.directives["@click"];this.evaluator.ensureVarInState(r);let n=r;this.evaluator.hasInterpolation(r)&&(n=this.evaluator.evalAttrValue(r,s));let a=n.replace(/\bstate\./g,"");try{const t=a.match(/^(\w+)\.(\w+)(\+\+|--|=.+)$/);if(t){const[,e,i,r]=t;if(s&&s[e]){const t=s[e];if(t&&"object"==typeof t&&t.id)for(const[e,n]of Object.entries(this.state))if(Array.isArray(n)){const a=n.findIndex((e=>e&&"object"==typeof e&&e.id===t.id));if(-1!==a){if("++"===r)return this.state[e][a][i]=(this.state[e][a][i]||0)+1,void setTimeout((()=>this.render()),0);if("--"===r)return this.state[e][a][i]=(this.state[e][a][i]||0)-1,void setTimeout((()=>this.render()),0);if(r.startsWith("=")){const t=r.substring(1).trim(),n=this.evaluator.evalExpr(t,s);return this.state[e][a][i]=n,void setTimeout((()=>this.render()),0)}}}if("++"===r)return t[i]=(t[i]||0)+1,void setTimeout((()=>this.render()),0);if("--"===r)return t[i]=(t[i]||0)-1,void setTimeout((()=>this.render()),0);if(r.startsWith("=")){const e=r.substring(1).trim(),n=this.evaluator.evalExpr(e,s);return t[i]=n,void setTimeout((()=>this.render()),0)}}}const e=a.match(/^(\w+)\s*=\s*(\w+)\.filter\((.+)\)$/);if(e){const[,t,i,r]=e;if(s&&r.includes("!==")&&t===i){const e=r.match(/!==\s*(\w+)\.id/);let i=null;if(e){const t=e[1];i=s[t]}else for(const[t,e]of Object.entries(s))if(e&&"object"==typeof e&&e.id&&"users"!==t){i=e;break}if(i&&i.id){const e=i.id;return this.state[t]=this.state[t].filter((t=>t.id!==e)),void setTimeout((()=>this.render()),0)}}}const r=a.match(/([\w$]+)\.(push|pop|shift|unshift|filter|map|reduce|forEach|slice|splice)/g);r&&r.forEach((t=>{const e=t.split(".")[0];e in this.state&&Array.isArray(this.state[e])||(this.state[e]=[])}));const n=a.match(/^(\w+)\+\+$/);if(n){const t=n[1];t in this.state||(this.state[t]=0);let e=Number(this.state[t])||0;return this.state[t]=e+1,void setTimeout((()=>this.render()),0)}const o=a.match(/^(\w+)--$/);if(o){const t=o[1];let e=Number(this.state[t])||0;return this.state[t]=e-1,void setTimeout((()=>this.render()),0)}const c=a.match(/^(\w+)\s*([+\-*\/])=\s*(.+)$/);if(c){const[,t,e,i]=c;let r=Number(this.state[t])||0,n=Number(this.evaluator.evalExpr(i,s))||0;switch(e){case"+":this.state[t]=r+n;break;case"-":this.state[t]=r-n;break;case"*":this.state[t]=r*n;break;case"/":this.state[t]=0!==n?r/n:r;break}return void setTimeout((()=>this.render()),0)}if(a.includes(";"))try{if(this.evaluator.executeMultipleExpressions(a,s,i))return void setTimeout((()=>this.render()),0)}catch(t){}const l=a.match(/^(\w+)\s*=\s*(.+)$/);if(l){const[,t,e]=l;if(e.includes("=>"))throw new Error("Assignment with arrow function, using fallback");const i=this.evaluator.evalExpr(e,s);return this.state[t]=i,void setTimeout((()=>this.render()),0)}try{if(this.evaluator.executeMultipleExpressions(a,s,i))return}catch(t){}new Function("state","ctx",`with(state){with(ctx||{}){${a}}}`)(this.state,s||{}),setTimeout((()=>this.render()),0)}catch(e){this.errorHandler.showAyishaError(t,e,a)}})),e.directives["@hover"]){const i=e.directives["@hover"],r=e=>{try{if(!this.evaluator.executeDirectiveExpression(i,s,e,!0)){let t=i;this.evaluator.hasInterpolation(i)&&(t=this.evaluator.evalAttrValue(i,s));const r=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${r}}}`)(this.state,s,e)}}catch(e){this.errorHandler.showAyishaError(t,e,i)}};t.addEventListener("mouseover",r),t.addEventListener("mouseout",r)}if(e.directives["@input"]&&t.addEventListener("input",(i=>{const r=e.directives["@input"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,s,i,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,s));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,s,i)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@focus"]&&t.addEventListener("focus",(i=>{const r=e.directives["@focus"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,s,i,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,s));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,s,i)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@blur"]&&t.addEventListener("blur",(i=>{const r=e.directives["@blur"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,s,i,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,s));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,s,i)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@change"]&&t.addEventListener("change",(i=>{const r=e.directives["@change"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,s,i,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,s));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,s,i)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@fetch"]&&!e.subDirectives["@fetch"]){const t=this.evaluator.autoVarExpr(e.directives["@fetch"]),i=e.directives["@result"]||"result";this.fetchManager.setupFetch(t,i,s),e.directives["@watch"]&&this._handleWatchDirective(e,t,i)}if(e.directives["@watch"]&&!e.directives["@fetch"]&&this._handleGenericWatchDirective(e),e.directives["@text"]&&!e.subDirectives["@text"])try{const i=e.directives["@text"];if(this.evaluator.hasMultipleAssignments(i))this.evaluator.executeDirectiveExpression(i,s,null,!1);else{const e=this.evaluator.evalExpr(i,s);t.textContent=void 0===e?"":null===e?"null":String(e)}}catch(e){t.textContent=`[Error: ${e.message}]`}if(e.directives["@model"]&&this.bindingManager.bindModel(t,e.directives["@model"],s),e.directives["@class"]&&!e.subDirectives["@class"]){const i=this.evaluator.evalExpr(e.directives["@class"],s)||{};Object.entries(i).forEach((([e,s])=>t.classList.toggle(e,!!s)))}if(e.directives["@style"])try{const i=this.evaluator.evalExpr(e.directives["@style"],s)||{};"object"!=typeof i||null===i||Array.isArray(i)||Object.entries(i).forEach((([e,s])=>{"string"==typeof e&&e.trim()&&(t.style[e]=s)}))}catch(t){}if(e.directives["@validate"]){const s=e.directives["@model"]||null;this.bindingManager.bindValidation(t,e.directives["@validate"],s)}if(e.directives["@link"]&&(t.setAttribute("href",e.directives["@link"]),t.addEventListener("click",(t=>{t.preventDefault(),this.state._currentPage=e.directives["@link"]}))),e.directives["@page"]&&this.state._currentPage!==e.directives["@page"])return null;if(e.directives["@animate"]){const s=e.directives["@animate"];t.classList.add(s),"fadeIn"!==s&&"fade-in"!==s||(t.style.opacity="1",t.style.transition="opacity 0.3s ease-in-out")}if(e.directives["@component"]){const i=e.directives["@component"];if(this.componentManager.getComponent(i)){const e=document.createRange().createContextualFragment(this.componentManager.getComponent(i)),r=this.parse(e),n=this._renderVNode(r,s);n&&t.appendChild(n)}}}_handleSubDirectives(t,e,s){Object.entries(e.subDirectives).forEach((([i,r])=>{Object.entries(r).forEach((([r,n])=>{const a="hover"===r?"mouseover":r;if(!("@click"!==i&&"@hover"!==i&&"@set"!==i&&"@fetch"!==i&&"@model"!==i&&"@focus"!==i&&"@blur"!==i&&"@change"!==i&&"@input"!==i&&"@class"!==i&&"@text"!==i||"click"!==r&&"hover"!==r&&"focus"!==r&&"input"!==r&&"change"!==r&&"blur"!==r)){const o=()=>"@class"===i&&n.trim().startsWith("{")?this.evaluator.evalExpr(n,s):this.evaluator.evalAttrValue(n,s);if("@fetch"===i)return void this._handleFetchSubDirective(t,a,n,e,s);if("@class"===i)return void this._handleClassSubDirective(t,r,o,s);if("@text"===i)return void this._handleTextSubDirective(t,r,o,s);t.addEventListener(a,(e=>{let i=o();try{const t=String(i).replace(/\bstate\./g,"");this.evaluator.executeMultipleExpressions(t,s,e)||new Function("state","ctx","event",`with(state){with(ctx||{}){${t}}}`)(this.state,s,e)}catch(e){this.errorHandler.showAyishaError(t,e,i)}}))}}))}))}_handleFetchSubDirective(t,e,s,i,r){t.addEventListener(e,(t=>{const e=i.directives["@result"]||"result";try{let i=this.evaluator.evalExpr(s,r);void 0===i&&(i=s),this.fetchManager.setupFetch(i,e,r,t,!0)}catch(i){this.fetchManager.setupFetch(s,e,r,t,!0)}}))}_handleClassSubDirective(t,e,s,i){"hover"===e?(t.addEventListener("mouseover",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("mouseout",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.remove(e)}))}catch(t){}}))):"focus"===e?(t.addEventListener("focus",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("blur",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.remove(e)}))}catch(t){}}))):"input"===e?(t.addEventListener("input",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("blur",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.remove(e)}))}catch(t){}}))):"click"===e?t.addEventListener("click",(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.toggle(e)}))}catch(t){}})):t.addEventListener(e,(e=>{try{const e=s()||{};Object.entries(e).forEach((([e,s])=>{s&&t.classList.add(e)}))}catch(t){}}))}_handleTextSubDirective(t,e,s,i){t._ayishaOriginalText||(t._ayishaOriginalText=t.textContent||t.innerText||""),"click"===e?t.addEventListener("click",(e=>{const r=this.evaluator.evalExpr(s(),i,e);t.textContent=r})):"hover"===e?(t.addEventListener("mouseover",(e=>{const r=this.evaluator.evalExpr(s(),i,e);t.textContent=r})),t.addEventListener("mouseout",(()=>{t.textContent=t._ayishaOriginalText||""}))):"input"!==e&&"focus"!==e&&"blur"!==e||t.addEventListener(e,(e=>{const r=this.evaluator.evalExpr(s(),i,e);t.textContent=r}))}_handleWatchDirective(t,e,s){t.directives["@watch"].split(",").forEach((t=>{let i=(t=t.trim()).match(/^([\w$]+)\s*=>\s*(.+)$/)||t.match(/^([\w$]+)\s*:\s*(.+)$/);if(i){const t=i[1],e=i[2];this.evaluator.ensureVarInState(e),this.addWatcher(t,(function(t){const s=window.ayisha.state;try{window.ayisha.evaluator.ensureVarInState(e),window.ayisha.evaluator.executeDirectiveExpression(e,{},{newVal:t},!0)||new Function("state","newVal",`with(state) { ${e} }`)(s,t)}catch(t){}}))}else this.addWatcher(t,(()=>this.fetchManager.setupFetch(e,s,void 0,void 0,!0)))}))}_handleGenericWatchDirective(t){t.directives["@watch"].split(",").forEach((t=>{const e=(t=t.trim()).match(/^(\w+)\s*=>\s*(.+)$/)||t.match(/^(\w+)\s*:\s*(.+)$/);if(e){const t=e[1],s=e[2];this.addWatcher(t,(function(t){const e=window.ayisha.state;window.ayisha.evaluator.ensureVarInState(s);try{window.ayisha.evaluator.executeDirectiveExpression(s,{},{newVal:t},!0)||new Function("state","newVal",`with(state){ ${s} }`)(e,t)}catch(t){}}))}}))}mount(){if(this.root.childNodes.forEach((t=>{1===t.nodeType&&t.tagName&&"init"===t.tagName.toLowerCase()&&this.parser.parse(t)})),this.root.childNodes.length>1){const t={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};this.root.childNodes.forEach((e=>{if(1===e.nodeType&&e.tagName&&"init"===e.tagName.toLowerCase())return;const s=this.parse(e);s&&t.children.push(s)})),this._vdom=t}else this._vdom=this.parse(this.root);if(!this.state._currentPage){const t=this._findFirstPageDirective(this._vdom);t&&(this.state._currentPage=t.directives["@page"])}this._preInitializeEssentialVariables(),this._makeReactive(),this._runInitBlocks(),this.reactivitySystem.enableWatchers(),this._setupRouting(),this.router.setupCurrentPageProperty(),this.preloadComponents().then((()=>{this._isRendering||this.render()})),this.render(),this.root.addEventListener("click",(t=>{let e=t.target;for(;e&&e!==this.root;){if(e.hasAttribute("@link"))return t.preventDefault(),this.state._currentPage=e.getAttribute("@link"),void this.render();e=e.parentNode}}),!0)}}window.AyishaVDOM=w;const E=()=>{if(!document.getElementById("ayisha-default-animations")){const t=document.createElement("style");t.id="ayisha-default-animations",t.textContent="\n        .fadeIn, .fade-in {\n          animation: ayishaFadeIn 0.3s ease-in-out;\n        }\n        \n        @keyframes ayishaFadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n        \n        .slide-down {\n          overflow: hidden;\n          transition: height 0.3s ease-in-out;\n        }\n        \n        /* Stili per @log display come sibling */\n        .ayisha-log-display {\n          background: rgba(0, 20, 40, 0.95) !important;\n          color: #fff !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n          font-size: 11px !important;\n          border-left: 4px solid #0066cc !important;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n          max-width: 400px !important;\n          overflow-x: auto !important;\n          line-height: 1.4 !important;\n          display: block !important;\n        }\n        \n        .ayisha-log-error-display {\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        }\n      ",document.head.appendChild(t)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{E(),new w(document.body).mount()})):(E(),new w(document.body).mount())}();